name: update-repo
description: 'Update central dnf-compatible repository'

on:
  workflow_dispatch:
    inputs:
      to_repository:
        required: true
        type: string
      to_branch:
        default: 'gh-pages'
        type: string
      to_path_component:
        default: 'component'
        type: string
      to_path_central:
        default: 'central'
        type: string

jobs:
  update_central_repo:
    runs-on: ubuntu-latest
    permissions: write-all
    steps:
      # Checkout the target repository
      - name: Check out target repository
        uses: actions/checkout@v6
        with:
          persist-credentials: false
          repository: "${{ inputs.to_repository }}"
          sparse-checkout: '${{ inputs.to_path_central }}'
      # Install dependencies
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get --yes install createrepo-c
      # Merge repository files
      - name: Merge repositories
        run: mergerepo_c --all --no-database $(find "${{ inputs.to_path_component }}/" -maxdepth 1 -type d -not -name "${{ inputs.to_path_component }}" -printf "--repo=%p ") --outputdir "${{ runner.temp }}/releases"
      # Create repofile
      - name: Create .repo file
        run: |
          echo '[teragrep-central-releases]
          name=teragrep-central-releases
          baseurl=https://raw.githubusercontent.com/${{ inputs.to_repository }}/refs/heads/${{ inputs.to_branch }}/${{ inputs.to_path_central }}/releases
          gpgcheck=0
          enabled=1' > ${{ runner.temp }}/releases/teragrep-central-releases.repo"
      # Deploy releases repository
      - name: Deploy releases repository files
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: "${{ runner.temp }}/releases"
          target-folder: "${{ inputs.to_path_central }}/releases"
          branch: "${{ inputs.to_branch }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          repository-name: "${{ inputs.to_repository }}"
